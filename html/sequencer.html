<!DOCTYPE html>
<html>
  <head>
    <title>MIDI Socket - Sequencer</title>
    <!-- <link rel="stylesheet" href="css/sequencer.css"> -->
    <link rel="stylesheet" href="css/routingMatrix.css">
    <link rel="stylesheet" href="css/color-transitions.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LCC0RPQNKH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LCC0RPQNKH');
    </script>
  </head>
  <body>

    <!-- Control Panel -->
    <div id="controls">

      <div id="session-info">
        <span id="session-name">Session: <strong>-</strong></span>
        <span id="session-status">Status: <strong>Waiting...</strong></span>
        <span id="midi-status">MIDI: <strong>Loading...</strong></span>
      </div>

      <div id="session-controls">
        <div id="session-buttons">
          <button id="play-button" class="control-btn" title="Start session for all tracks">
            ‚ñ∂Ô∏è Start Session
          </button>
          <button id="pause-button" class="control-btn" title="Pause session for all tracks">
            ‚è∏Ô∏è Pause Session
          </button>
          <button id="panic-all" class="control-btn danger" title="Send panic (all notes off) to all devices">
            üõë Panic All
          </button>
        </div>
      </div>
      
      <div id="view-controls">
        <div id="view-buttons">
          <button id="device-config-toggle" class="control-btn" title="Configure MIDI devices">
            ‚öôÔ∏è Device Config
          </button>
          <button id="info-toggle" class="control-btn" title="Show/hide device information">
            ‚ÑπÔ∏è Interface Info
          </button>
          <button id="stats-toggle" class="control-btn" title="Show/hide routing statistics">
            üìä Statistics
          </button>
        </div>
      </div>

    </div>

    <!-- Device Configuration Panel -->
    <div id="device-config-panel" class="panel hidden">
      <div class="panel-header">
        <h3>‚öôÔ∏è Device Configuration</h3>
        <button class="panel-close-btn" onclick="deviceConfig.toggleVisibility()">‚úï</button>
      </div>
      <p>Configure MIDI devices and their interface/channel assignments:</p>
      
      <div id="device-config-controls">
        <button id="add-device-btn" class="control-btn">‚ûï Add New Device</button>
        <button id="save-config-btn" class="control-btn success">üì• Download Configuration</button>
        <button id="load-config-btn" class="control-btn">üìÅ Load Configuration</button>
      </div>
      
      <div id="device-config-container">
        <table id="device-config-table">
          <thead>
            <tr>
              <th>Device</th>
              <th>MIDI Interface</th>
              <th>MIDI Channel</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="device-config-table-body">
            <!-- Device configuration rows will be generated here -->
          </tbody>
        </table>
        
        <div id="no-configured-devices" class="empty-state">
          <h4>No devices configured</h4>
          <p>Add devices from the database to configure their MIDI interface and channel assignments.</p>
        </div>
      </div>
    </div>

    <!-- Device Status Panel -->
    <div id="device-panel" class="panel hidden">
      <div class="panel-header">
        <h3>üì± MIDI Interfaces</h3>
        <button class="panel-close-btn" onclick="document.getElementById('device-panel').classList.add('hidden')">‚úï</button>
      </div>
      <div id="device-status">
        <div class="loading">Detecting MIDI interfaces...</div>
      </div>
      <div id="device-list"></div>
    </div>

    <!-- Statistics Panel -->
    <div id="stats-panel" class="panel hidden">
      <div class="panel-header">
        <h3>üìä Routing Statistics</h3>
        <button class="panel-close-btn" onclick="document.getElementById('stats-panel').classList.add('hidden')">‚úï</button>
      </div>
      <div id="stats-content">
        <div class="stat-item">
          <label>Active Tracks:</label>
          <span id="stat-active-tracks">0</span>
        </div>
        <div class="stat-item">
          <label>Routed Tracks:</label>
          <span id="stat-routed-tracks">0</span>
        </div>
        <div class="stat-item">
          <label>Messages Routed:</label>
          <span id="stat-messages-routed">0</span>
        </div>
        <div class="stat-item">
          <label>Routing Errors:</label>
          <span id="stat-routing-errors">0</span>
        </div>
      </div>
    </div>

    <!-- Main Routing Matrix -->
    <div id="routing-matrix">
      <h3>üéµ Track Routing Matrix</h3>
      
      <div id="matrix-container">
        <table id="routing-table">
          <thead>
            <tr>
              <th>Track</th>
              <th>User</th>
              <th>Status</th>
              <th>MIDI Interface/Device</th>
              <th>Channel</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="routing-table-body">
            <!-- Track rows will be dynamically generated here -->
          </tbody>
        </table>
        
        <div id="no-tracks-message" class="empty-state">
          <h4>No tracks connected</h4>
          <p>Waiting for users to join the session...</p>
        </div>
      </div>
      
      <!-- Always visible track URL section below the list -->
      <div id="invite-section" class="invite-section">
        <p>Share this URL with participants:</p>
        <div id="track-url-display">
          <code id="track-url">Loading...</code>
          <button id="copy-url" title="Copy URL to clipboard">üìã</button>
          <button id="qr-url" title="Show QR code">QR</button>
        </div>
      </div>
    </div>

    <!-- Error/Info Messages -->
    <div id="message-area">
      <div id="error-message" class="message error hidden"></div>
      <div id="info-message" class="message info hidden"></div>
    </div>

    <!-- Add New Device Modal -->
    <div id="device-selection-modal" class="modal hidden">
      <div class="modal-overlay" onclick="document.getElementById('device-selection-modal').classList.add('hidden');"></div>
      <div class="modal-content add-device-content">
        <div class="modal-header">
          <h3>Add New Device</h3>
          <button id="close-modal" class="close-btn" onclick="document.getElementById('device-selection-modal').classList.add('hidden');">‚úï</button>
        </div>
        <div class="modal-body">
          <form id="add-device-form">
            <!-- Device Basic Info -->
            <div class="form-section">
              <h4>Device Information</h4>
              <div class="form-group">
                <label for="device-name">Device Name *</label>
                <input type="text" id="device-name" name="deviceName" required placeholder="Enter device name...">
              </div>
              <div class="form-group">
                <label for="device-color">Device Color *</label>
                <input type="color" id="device-color" name="deviceColor" value="#4a90e2" required>
                <span class="color-preview" id="color-preview"></span>
              </div>
            </div>

            <!-- MIDI Controllers Section -->
            <div class="form-section">
              <h4>MIDI Controllers</h4>
              <p class="section-description" id="max-controllers-text">Define MIDI controllers for this device:</p>
              <div id="controllers-container">
                <!-- Controllers will be added dynamically -->
              </div>
              <button type="button" id="add-controller-btn" class="control-btn small">‚ûï Add Controller</button>
            </div>

          </form>
        </div>
        <!-- Form Actions - moved outside modal-body to be always visible -->
        <div class="form-actions">
          <button type="button" class="control-btn" onclick="document.getElementById('device-selection-modal').classList.add('hidden');">Cancel</button>
          <button type="submit" form="add-device-form" class="control-btn success">Create Device</button>
        </div>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-code-modal" class="modal hidden">
      <div class="modal-overlay" onclick="closeQrModal()"></div>
      <div class="modal-content qr-modal-content">
        <button id="close-qr-modal" class="close-btn" onclick="closeQrModal()">‚úï</button>
        <img id="qr-code-image" src="" alt="QR Code" class="qr-code-image">
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/include.js"></script>
    <script src="scripts/midiDeviceManager.js"></script>
    <script src="scripts/routingMatrix.js"></script>
    <script src="scripts/midiRouting.js"></script>
    <script src="scripts/deviceConfiguration.js"></script>
    <script src="scripts/sequencer.js"></script>
  </body>
</html>